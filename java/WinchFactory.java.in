/* smallfoot.org is owned by allan.clark */
package org.smallfoot.filexfer;

//import java.io.*;
//import java.util.*;
//import javax.activation.DataSource;
//import javax.activation.URLDataSource;
import gnu.getopt.Getopt;
//import gnu.getopt.LongOpt;
import java.util.TreeSet;
import java.util.Vector;

/**
 * @file
 */

public class WinchFactory
{
    /**
     * provides a FileTransferWinch matching the URL given
     *
     * @return populated winch based on the URL given
     * @throws java.net.MalformedURLException if the URL created form the String is malformed
     * @param url URL to connect to
     */
    static FileTransferWinch getWinch(String url) throws java.net.MalformedURLException
    { return getWinch(new java.net.URL (url)); }

    /**
     * provides a FileTransferWinch matching the URL given
     *
     * @return populated winch based on the URL given
     * @param url URL to connect to
     */
    static FileTransferWinch getWinch(java.net.URL url)
    {
        if (FTP4J.handles(url))
            return new FTP4J(url);
        if (ApacheCommonsNetSFTP.handles(url))
            return new ApacheCommonsNetSFTP(url);
        else
            return null;
    }


    /**
     * provides an array of example URLs based on the given model by iterating all known Winches
     *
     * @return populated array of examples
     * @param url sample URL to be used in examples
     * @throws java.net.MalformedURLException if the given URL chokes on conversion to a java.net.URL
     */
    static String[] getWinchExamples(String url) throws java.net.MalformedURLException
    {
        Vector<String> v = new Vector();

        java.net.URL u = new java.net.URL(url);

        /* manual iterative add of each Winch */
        v.addAll(java.util.Arrays.asList(FTP4J.examples(u)));
        v.addAll(java.util.Arrays.asList(ApacheCommonsNetSFTP.examples(u)));

        return v.toArray(new String[0]);
    }



    protected java.util.Vector<FileTransferWinch> getWinches()
    {
        java.util.Vector<FileTransferWinch> w = new java.util.Vector();

        w.add(new FTP4J(null));
        w.add(new ApacheCommonsNetSFTP(null));

        return w;
    }


    static private boolean _reg = false;
    /**
     * stub constructor for the WinchFactory() also appends/writes the system property "java.protocol.handler.pkgs" in accordance with http://docs.oracle.com/javase/7/docs/api/java/net/URL.html
     *
     * NOTE: my own code uses "package1:package2" whereas the example uses "package1|package2"
     */
    public WinchFactory()
    {
        if (false == _reg)
        {
            java.util.Properties p = System.getProperties();

            if ( (null == p.getProperty("java.protocol.handler.pkgs")) || (1 > p.getProperty("java.protocol.handler.pkgs").length()) )
                p.setProperty("java.protocol.handler.pkgs","org.smallfoot.filexfer");
            else
                p.setProperty("java.protocol.handler.pkgs",p.getProperty("java.protocol.handler.pkgs")+"|org.smallfoot.filexfer");

            System.setProperties(p);

            java.security.Security.addProvider(new org.bouncycastle.jce.provider.BouncyCastleProvider());

            _reg = true;
        }
    }



    public static void main(String[] args)
    {
        WinchFactory wf = new WinchFactory();
        java.util.Vector<FileTransferWinch> winches = new java.util.Vector();
        Getopt g = new Getopt("upload", args, "U:u:lL");

        try
        {
            java.lang.ClassLoader.getSystemClassLoader().loadClass("org.slf4j.impl.StaticLoggerBinder");
        }
        catch (Exception e)
        {
            e.printStackTrace();
        }

        int c;
        while ((c = g.getopt()) != -1)
        {
            switch(c)
            {
            case 'L': /* list winches' examples */
            {
                try
                {
for (String s:wf.getWinchExamples("http://scott:tiger@example.com/path/file"))
                        System.out.println("     : "+s);
                }
                catch (java.net.MalformedURLException mue)
                {
                    /* URL string "http://scott:tiger@example.com/path/file" is no good */
                }
            }
            break;

            case 'l': /* list winches */
            {
                TreeSet<String> t = new TreeSet();
for (FileTransferWinch f: wf.getWinches())
                    t.add(f.getClass().getName().replaceAll("^.*\\.",""));
for (String s:t)
                    System.out.println("winch: "+s);
            }
            break;

            case 'U': /* add a winch */
                try
                {
                    FileTransferWinch ftw = wf.getWinch(g.getOptarg());
                    if (null != ftw)
                        winches.add(ftw);
                    else System.out.println("No uploader \"winch\" found for url \""+g.getOptarg()+"\"");
                }
                catch (java.net.MalformedURLException mue)
                {
                    System.out.print("Malformed URL Exception processing URL \""+g.getOptarg()+"\"");
                    if (null != mue.getMessage()) System.out.print(": "+mue.getMessage());
                    System.out.println("\nrecheck the URL versus RFC-1738");
                }
                catch (Exception e)
                {
                    System.out.println("Exception processing URL \""+g.getOptarg()+"\": "+e.getMessage());
                    e.printStackTrace();
                }
                break;

            case 'u': /* push a file */
                try
                {
                    FileTransferWinch f1[] = null;

for (FileTransferWinch f: winches)
                    {
                        System.out.println("trying winch: "+f.getClass().getName());
                        f.upload(g.getOptarg());
                        break;
                    }
                }
                catch (Exception e)
                {
                    System.out.println("Exception uploading file \""+g.getOptarg()+"\": "+e.getMessage());
                }
                break;

            default:
                System.out.println("usage: upload -U <URL> [-U <URL> [-U <URL>]] -u <file> [-u <file> [-u <file>]]");
                System.out.println("   ie: upload -U sharepoint://scott:tiger@wisdom.example.com/sites/Services/ts/Services%20Schedule/Calendar.xlsx -u Calendar.xlsx");

//import java.security.Provider;
//import java.security.Security;
//import java.util.Enumeration;

//import org.bouncycastle.jce.provider.BouncyCastleProvider;

                java.security.Provider p[] = java.security.Security.getProviders();
                for (int i = 0; i < p.length; i++)
                {
                    System.out.println(p[i]);
                    for (java.util.Enumeration<?> e = p[i].keys(); e.hasMoreElements();)
                        System.out.println("\t" + e.nextElement());
                }
                break;
            }
        }
    }
}
